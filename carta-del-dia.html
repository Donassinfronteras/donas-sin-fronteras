<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OrÃ¡culo Prisma - Carta del DÃ­a</title>
  <link rel="stylesheet" href="css/carta-del-dia.css">
</head>
<body>
  <div class="intention-form">
    <input type="text" id="intencion" placeholder="Escribe tu intenciÃ³n">
    <button id="sacar-carta">Sacar Carta</button>
  </div>
  <div class="card-container">
    <div class="watermark">Donas Sin Fronteras â€“ OrÃ¡culo Prisma</div>
    <img id="card-img" class="card-image" src="" alt="Carta del DÃ­a">
    <div class="title" id="card-title">...</div>
    <div class="text-reveal" id="card-message">...</div>
    <div class="footer">OrÃ¡culo Prisma âœ¨</div>
  </div>
  <div id="lectura-ia"></div>

  <!-- BotÃ³n de regreso -->
  <div class="return-btn">
    <a href="oraculo-prisma.html">ðŸ”® Volver al OrÃ¡culo</a>
  </div>

  <script>
    const jsonURL = "https://raw.githubusercontent.com/Donassinfronteras/donas-sin-fronteras/main/data/cartas_oraculo_prisma.json";

    document.getElementById("sacar-carta").addEventListener("click", sacarCarta);

    function sacarCarta() {
      const intencion = document.getElementById("intencion").value || "";

      fetch(jsonURL)
        .then(res => res.json())
        .then(data => {
          const carta = data[Math.floor(Math.random() * data.length)];
          const esReversa = Math.random() < 0.5;

          document.getElementById("card-img").src = carta["Imagen URL"];
          document.getElementById("card-title").textContent = `${carta["Nombre de la Carta"]} ${esReversa ? '(Reversa)' : ''}`;

          if (esReversa) {
            document.getElementById("card-img").style.transform = "rotate(180deg)";
            setTimeout(() => {
              const sombra = carta["Sombra"] || carta["Sombra (opcional)"] || "Esta carta aÃºn guarda su sombra en secreto.";
              document.getElementById("card-message").textContent = sombra;
              document.getElementById("card-message").classList.add("visible");
            }, 3000);
          } else {
            document.getElementById("card-img").style.transform = "rotate(0deg)";
            setTimeout(() => {
              const luz = carta["Mensaje (Luz)"] || "Este mensaje de luz aÃºn estÃ¡ despertando...";
              document.getElementById("card-message").textContent = luz;
              document.getElementById("card-message").classList.add("visible");
            }, 3000);
          }

          fetch('/api/lectura', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              nombreCarta: carta["Nombre de la Carta"],
              significado: carta["Mensaje (Luz)"],
              categoria: carta["CategorÃ­a"],
              intencion,
              esReversa
            })
          })
            .then(res => res.json())
            .then(data => {
              document.getElementById("lectura-ia").textContent = data.lectura;
            })
            .catch(err => {
              document.getElementById("lectura-ia").textContent = 'Error al generar la lectura.';
              console.error(err);
            });
        })
        .catch(err => {
          document.getElementById("card-title").textContent = "Error al cargar la carta.";
          console.error(err);
        });
    }
  </script>

  <!-- ðŸ”® Script de seguimiento Metricool -->
  <script>
    (function () {
      var script = document.createElement("script");
      script.type = "text/javascript";
      script.src = "https://tracker.metricool.com/resources/be.js";
      script.onload = function () {
        beTracker.t({ hash: "99f2f6631f8d7b7b2f039fbaf9e1b94c" });
      };
      document.head.appendChild(script);
    })();
  </script>
</body>
</html>
